<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/jquery.xml2json.js"></script>
</head>
<body>
<input type="file" id="files" name="files[]" accept="text/xml" />
<output id="list"></output>
<script>
    if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
        alert('The File APIs are not fully supported in this browser.');
    }

    function send_post(url, name, array) {
        var data = {};
        data[name] = JSON.stringify(array);
        $.ajax({
            type: 'POST',
            url: url,
            data: data
        });
    }

    function send_post_sync(url, name, array) {
        var data = {};
        data[name] = JSON.stringify(array);
        var ret = null;
        $.ajax({
            type: 'POST',
            url: url,
            data: data,
            async: false
        }).done(function(msg) {
            ret = msg;
        });
        return ret;
    }

    function handleFileSelect(evt) {
        var files = evt.target.files;
        if (files.length == 1) {
            var reader = new FileReader();
            reader.onload = (function(file) {
                var xmlStr = reader.result.toString();
                var json = $.xml2json(xmlStr);

                var taxes = json['MasterFiles']['TaxTable']['TaxTableEntry'];
                var customers = json['MasterFiles']['Customer'];
                var invoices = json['SourceDocuments']['SalesInvoices']['Invoice'];
                var products = json['MasterFiles']['Product'];

                for (var i = 0; i < invoices.length; ++i) {
                    if (!$.isArray(invoices[i]['Line'])) {
                        invoices[i]['Line'] = [invoices[i]['Line']];
                    }
                }

                for (var i = 0; i < taxes.length; ++i)
                    send_post('api/updateTax.php', 'tax', taxes[i]);

                for (var i = 0; i < customers.length; ++i) {
                    customers[i]['CustomerID'] = '';
                    send_post('api/updateCustomer.php', 'customer', customers[i]);
                }

                for (var i = 0; i < products.length; ++i) {
                    products[i]['ProductCode'] = '';
                    var newCode = send_post_sync('api/updateProduct.php', 'product', products[i]);
                    for (var j = 0; j < invoices.length; ++j) {
                        for (var k = 0; k < invoices[j]['Line'].length; ++k) {
                            if (invoices[j]['Line'][k]['ProductCode'] === products[i]['ProductNumberCode'])
                                invoices[j]['Line'][k]['ProductCode'] = newCode;
                        }
                    }
                }

                json['SourceDocuments']['SalesInvoices']['Invoice'].forEach(function(entry) {
                    send_post('api/updateInvoice.php', 'invoice', entry);
                });
            });
            reader.readAsText(files[0]);
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
</body>
</html>